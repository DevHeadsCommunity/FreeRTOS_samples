/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2024 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include "../CMSIS/Inc/main.h"
#include "../drivers/Inc/32f407_spi.h"

//for print f
#include <stdio.h>

#define BLUE_LED_PORT GPIOD
#define BLUE_LED_PIN 15


void SPI_2_Init();



void delay(void){
	for(uint32_t i = 0; i < 500000/2; i ++);
}



int main(void)
{
	SPI_2_Init();

	printf("System booted with Default clock\n");
	delay();

	//Turn on Blue LED with pure CMSIS
	RCC->AHB1ENR |= RCC_AHB1ENR_GPIODEN;

	GPIOD->MODER |= GPIO_MODER_MODER15_0;
	GPIOD->MODER &= ~GPIO_MODER_MODER15_1;
	GPIOD->OTYPER &= ~GPIO_OTYPER_OT_15;
	GPIOD->OSPEEDR |= GPIO_OSPEEDER_OSPEEDR15_0;
	GPIOD->OSPEEDR &= ~GPIO_OSPEEDER_OSPEEDR15_1;
	GPIOD->PUPDR &= ~GPIO_PUPDR_PUPDR15_0;
	GPIOD->PUPDR &= ~GPIO_PUPDR_PUPDR15_1;

	delay();

	printf("GPIO D setup and now will turn on blue LED \n");


	GPIOD->BSRR |= GPIO_BSRR_BS_15;

	printf("Blue LED is now ON\n");

	delay();
	delay();
	delay();

	printf("GPIO D setup will turn off blue LED\n");

	GPIOD->BSRR |= GPIO_BSRR_BR_15;

	printf("Blue LED is now OFF\n");

 /* Loop forever */
	for(;;);
}




void SPI_2_Init() {

	uint32_t altfn_reg;

	// GPIO B for SPI 2
	RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN;

	//MOSI
	GPIOB->MODER |= GPIO_MODER_MODER15_0;
	GPIOB->MODER &= ~GPIO_MODER_MODER15_1;
	GPIOB->OTYPER &= ~GPIO_OTYPER_OT_15;
	GPIOB->OSPEEDR |= GPIO_OSPEEDER_OSPEEDR15_0;
	GPIOB->OSPEEDR &= ~GPIO_OSPEEDER_OSPEEDR15_1;
	GPIOB->PUPDR &= ~GPIO_PUPDR_PUPDR15_0;
	GPIOB->PUPDR &= ~GPIO_PUPDR_PUPDR15_1;
	//get this pins altfn reg
	altfn_reg = 15 % 8;
	GPIOB->AFR[1] |= 5 << (altfn_reg * 4);
	

	//MISO
	GPIOB->MODER |= GPIO_MODER_MODER14_0;
	GPIOB->MODER &= ~GPIO_MODER_MODER14_1;
	GPIOB->OTYPER &= ~GPIO_OTYPER_OT_14;
	GPIOB->OSPEEDR |= GPIO_OSPEEDER_OSPEEDR14_0;
	GPIOB->OSPEEDR &= ~GPIO_OSPEEDER_OSPEEDR14_1;
	GPIOB->PUPDR &= ~GPIO_PUPDR_PUPDR14_0;
	GPIOB->PUPDR &= ~GPIO_PUPDR_PUPDR14_1;
	//get this pins altfn reg
	altfn_reg = 14 % 8;
	GPIOB->AFR[1] |= 5 << (altfn_reg * 4);

	//SCLK
	GPIOB->MODER |= GPIO_MODER_MODER13_0;
	GPIOB->MODER &= ~GPIO_MODER_MODER13_1;
	GPIOB->OTYPER &= ~GPIO_OTYPER_OT_13;
	GPIOB->OSPEEDR |= GPIO_OSPEEDER_OSPEEDR13_0;
	GPIOB->OSPEEDR &= ~GPIO_OSPEEDER_OSPEEDR13_1;
	GPIOB->PUPDR &= ~GPIO_PUPDR_PUPDR13_0;
	GPIOB->PUPDR &= ~GPIO_PUPDR_PUPDR13_1;
	//get this pins altfn reg
	altfn_reg = 13 % 8;
	GPIOB->AFR[1] |= 5 << (altfn_reg * 4);

	//NSS
	GPIOB->MODER |= GPIO_MODER_MODER12_0;
	GPIOB->MODER &= ~GPIO_MODER_MODER12_1;
	GPIOB->OTYPER &= ~GPIO_OTYPER_OT_12;
	GPIOB->OSPEEDR |= GPIO_OSPEEDER_OSPEEDR12_0;
	GPIOB->OSPEEDR &= ~GPIO_OSPEEDER_OSPEEDR12_1;
	GPIOB->PUPDR &= ~GPIO_PUPDR_PUPDR12_0;
	GPIOD->PUPDR &= ~GPIO_PUPDR_PUPDR12_1;
	//get this pins altfn reg
	altfn_reg = 12 % 8;
	GPIOB->AFR[1] |= 5 << (altfn_reg * 4);


	

	printf("SPI enabled\n");
	SPI_Handle_t SPI2Handle;

	SPI2Handle.pSPIx = SPI2;
	SPI2Handle.SPIConfig.SPI_BUSConfig = SPI_BUS_CONFIG_FD;
	SPI2Handle.SPIConfig.SPI_DeviceMode = SPI_DEVICE_MODE_MASTER;
	SPI2Handle.SPIConfig.SPI_SclkSpeed = SPI_SCLK_SPEED_DIV4;
	SPI2Handle.SPIConfig.SPI_DFF = SPI_DFF_8BITS;
	SPI2Handle.SPIConfig.SPI_CPOL = SPI_CPOL_LOW;
	SPI2Handle.SPIConfig.SPI_CPHA = SPI_CPHA_LOW;
	SPI2Handle.SPIConfig.SPI_SSM = SPI_SSM_EN; // software slave management for NSS pin

	SPI_Init(&SPI2Handle);


}